pluginFn['/js/plugins/v2/erd.js'] = function(lucid, window) {
	(function(){function z(a,b,d){d=d||{};var c=b.map(function(a){return a.name});lucid.plugin.registerAdvancedAction(a,"addFieldAbove",function(){var a=u();a&&A(a)},B);lucid.plugin.registerAdvancedAction(a,"addFieldBelow",function(){var a=u();a&&A(a,!0)},B);lucid.plugin.registerAdvancedAction(a,"deleteField",function(){var a=u();a&&L(a)},M);lucid.plugin.registerAdvancedAction(a,"exportSql",function(){var a=u();a&&n.exportSql(a)},function(){return!!u()});lucid.plugin.registerAdvancedAction("AnySelection",
"tryParseCsv",function(a){return C(a,0)},function(){return!!u()});lucid.plugin.initBlockClass({className:a,name:"Entity",searchKeywords:["erd","entity","relationship"],defaultSize:{w:200,h:120},vLock:!0,showLinkPoints:!0,disableEdgeResize:!0,onInit:function(a){function d(){if(!lucid.plugin.isSample(a)){var b=lucid.plugin.getProperty(a,"Fields"),b=m(b)+w(a,b),c=lucid.plugin.getProperty(a,"BoundingBox");c.h!=b&&(c.h=b,lucid.plugin.setProperty(a,"BoundingBox",c))}}function g(){r=r||Promise.resolve().then(function(){r=
null;d()});h()}function h(){q++;Promise.resolve().then(function(){q--;if(0==q){var b=lucid.plugin.getProperty(a,"pendingReconnect",!0);b&&(N(a,b[0],b[1]),lucid.plugin.setProperty(a,"pendingReconnect",null,!0))}})}function l(b,c){var d=null;n[b]=function(){if(D){var k=J;d=d||lucid.text.awaitMetrics().then(function(){d=null;if((k||void 0===lucid.plugin.getProperty(a,b+"_h"))&&void 0!==lucid.plugin.getProperty(null,"erd-v2")){null==lucid.plugin.getProperty(a,"pendingReconnect",!0)&&lucid.plugin.setProperty(a,
"pendingReconnect",[x(a)],!0);var h=lucid.text.getSize(a,b),h=h&&h.h+10||c,h=Math.round(Math.max(c,h));h!=lucid.plugin.getProperty(a,b+"_h")&&(lucid.plugin.setPropertyIfChanged(a,b+"_h",h),g())}});h()}};lucid.plugin.hookPropertyPostSave(a,b,n[b]);lucid.plugin.hookPropertyPostSave(a,"Column1",n[b]);lucid.plugin.hookPropertyPostSave(a,"Column2",n[b])}function m(b){for(var c=0,d=0;d<b;d++)c+=w(a,d);return c}function f(c,d){var g=b[c].name,k=lucid.text.getStyle(a,g+(d-1));void 0===lucid.plugin.getProperty(a,
g+d+"_h")&&lucid.plugin.setProperty(a,g+d+"_h",lucid.plugin.getProperty(null,"erd-v2")?32:28);lucid.plugin.addBlockTextArea(a,{id:g+d,value:k?lucid.text.restyle(g,k):g,getBoundingBox:function(g){function k(c){return 0==c?0:c==b.length?g.w:b[c].x(function(b){return lucid.plugin.getProperty(a,b)})}if(d>lucid.plugin.getProperty(a,"Fields"))return null;var h=k(c)+5,l=k(c+1)-5,f=m(d)+2.5,t=w(a,d)-5;return{x:g.x+h,y:g.y+f,w:l-h,h:t}},onFocus:function(){lucid.abTest.shouldShowAdvancedOptionsDrawer()&&lucid.plugin.setProperty(a,
"selectedRow",d,!0)},align:b[c].align});l(g+d,20)}if(""!=a){lucid.plugin.setProperty(a,"DisableAutoLink",!0);lucid.plugin.registerProperty(a,"AltRows",0);lucid.plugin.registerProperty(a,"ShadedHeader",0);lucid.plugin.registerProperty(a,"Name_h",40);lucid.plugin.addBlockTextArea(a,{id:"Name",value:"Entity",getBoundingBox:function(b){return{x:b.x+10,y:b.y,w:b.w-20,h:lucid.plugin.getProperty(a,"Name_h")}},onFocus:function(){lucid.plugin.setProperty(a,"selectedRow",null,!0)}});var r=null,q=0;lucid.plugin.hookPropertyPostSave(a,
"pendingReconnect",function(a,b){null!=b&&h()});J||(O[a]=function(b){d();N(a,b);lucid.plugin.setProperty(a,"pendingReconnect",null,!0)});var n={};l("Name",40);lucid.plugin.registerProperty(a,"Fields",3,function(b){D&&null==lucid.plugin.getProperty(a,"pendingReconnect",!0)&&lucid.plugin.setProperty(a,"pendingReconnect",[x(a)],!0);return b},function(c,d){for(var k=lucid.plugin.getBlockTextAreas(a),h=b.length,l=1;l<=d;l++)for(var m=0;m<h;m++){var q=b[m].name;if(!lucid.array.contains(k,q+l))f(m,l);else if(void 0===
lucid.plugin.getProperty(a,q+l+"_h"))n[q+l]()}void 0!==lucid.plugin.getProperty(null,"erd-v2")&&g()});lucid.plugin.registerProxyProperty(a,"FieldData",function(){for(var b=lucid.plugin.getAllProperties(a),d=[],g=0;g<b.Fields;g++)d.push(lucid.array.toObjectKeys(c,function(a){return lucid.text.plainText(b[a+(g+1)])}));return d},function(b){var c=["Key","Field","Type"];lucid.plugin.setPropertyIfChanged(a,"Fields",b.length);b.forEach(function(b,d){lucid.object.forEach(b,function(b,g){lucid.array.contains(c,
g)&&lucid.plugin.setPropertyIfChanged(a,g+(d+1),lucid.text.restyle(b,{}))})})});lucid.plugin.registerProxyProperty(a,"linkPoints",function(){for(var b=lucid.plugin.getProperty(a,"Fields"),c=lucid.plugin.getProperty(a,"BoundingBox"),d=[{x:.5,y:0},{x:.5,y:1}],g=0,k=0;k<=b;k++){var h=w(a,k),l=(g+h/2)/c.h;d.push({x:0,y:l});d.push({x:1,y:l});g+=h}return d});lucid.plugin.hookPropertyPostSave(a,"Fields",function(){lucid.plugin.proxyPropertyChanged(a,"FieldData")});lucid.plugin.setProperty(a,"fieldNames",
c,!0)}},onCreate:function(a){f.databases.refreshBlocks();var b=lucid.plugin.getProperty(a,"TableId"),c;if(b&&(c=f.databases.getTable(b))){var d=lucid.plugin.getItemPageId(a);lucid.object.forEach(c.columns,function(b){b.foreign&&b.foreign.table.blocks.forEach(function(c){d==lucid.plugin.getItemPageId(c.id)&&b.connectBlocks(a,c.id)});b.primary&&b.primary.forEach(function(c){b.table!=c.table&&c.table.blocks.forEach(function(b){d==lucid.plugin.getItemPageId(b.id)&&c.connectBlocks(b.id,a)})})})}},onDelete:function(a){lucid.plugin.getConnectedLines(a).map(lucid.plugin.deleteItem)},
lineDrawnProperties:function(a,b){return{Endpoint1:{Style:"CFN ERD One Arrow"},Endpoint2:{Style:"CFN ERD Many Arrow"},Shape:"elbow"}},getLinkPoints:function(a){return lucid.plugin.getProperty(a,"linkPoints")||[]},getRenderData:function(a,c,g){var h=a.BoundingBox,l=[];l.push({FillColor:a.FillColor,Actions:[{Action:"move",x:h.x,y:h.y},{Action:"line",x:h.x+h.w,y:h.y},{Action:"line",x:h.x+h.w,y:h.y+h.h},{Action:"line",x:h.x,y:h.y+h.h},{Action:"close"}]});if(a.AltRows)for(var m=0,f=w(g,0),r=0;r<=a.Fields;r++){var q=
w(g,r);0==r%2&&0!=r&&(f=r<a.Fields?m+q:h.h,l.push({FillColor:lucid.color.darken(a.FillColor,.1),NoRounding:!0,Actions:[{Action:"move",x:h.x,y:h.y+m},{Action:"line",x:h.x+h.w,y:h.y+m},{Action:"line",x:h.x+h.w,y:h.y+f},{Action:"line",x:h.x,y:h.y+f},{Action:"close"}]}));m+=q}a.ShadedHeader&&(m=a.Name_h,l.push({FillColor:lucid.color.darken(a.FillColor,.2),NoRounding:!0,Actions:[{Action:"move",x:h.x,y:h.y},{Action:"line",x:h.x+h.w,y:h.y},{Action:"line",x:h.x+h.w,y:h.y+m},{Action:"line",x:h.x,y:h.y+m},
{Action:"close"}]}));l.push({StrokeColor:a.LineColor,LineWidth:a.LineWidth,Actions:[{Action:"move",x:h.x,y:h.y},{Action:"line",x:h.x+h.w,y:h.y},{Action:"line",x:h.x+h.w,y:h.y+h.h},{Action:"line",x:h.x,y:h.y+h.h},{Action:"close"}]});var n=h.y+("sample"==c?4:a.Name_h);l.push({StrokeColor:a.LineColor,LineWidth:a.LineWidth,Actions:[{Action:"move",x:h.x,y:n},{Action:"line",x:h.x+h.w,y:n}]});b.forEach(function(b,g){if(g){var m=b.x(function(b){return b in a?a[b]:"sample"==c&&d.sampleProperties&&b in d.sampleProperties?
d.sampleProperties[b]:void 0})+h.x;l.push({StrokeColor:a.LineColor,LineWidth:a.LineWidth,Actions:[{Action:"move",x:m,y:n},{Action:"line",x:m,y:h.y+h.h}]})}});a.selectedRow&&"pdf"!=c&&lucid.abTest.shouldShowAdvancedOptionsDrawer()&&(g=K(g),m=g[a.selectedRow],l.push({StrokeColor:"#29aae1",LineWidth:2,NoRounding:!0,Actions:[{Action:"move",x:m.x+a.LineWidth/2,y:m.y},{Action:"line",x:m.x+m.w-a.LineWidth/2,y:m.y},{Action:"line",x:m.x+m.w-a.LineWidth/2,y:m.y+m.h},{Action:"line",x:m.x+a.LineWidth/2,y:m.y+
m.h},{Action:"close"}]}),a.potentialSwitchRow&&(g=g[a.potentialSwitchRow],l.push({StrokeColor:"#29aae1",LineWidth:5,NoRounding:!0,Actions:[{Action:"move",x:g.x+a.LineWidth/2,y:g.y+(a.potentialSwitchRow<a.selectedRow?0:g.h)},{Action:"line",x:g.x+g.w-a.LineWidth/2,y:g.y+(a.potentialSwitchRow<a.selectedRow?0:g.h)}]})));return l},getOffsetProperties:d.onWidthChange&&function(a){var b=lucid.plugin.defaultOffsetProperties.apply(null,arguments),c=lucid.object.getValueByKeys(b,a,"BoundingBox");c&&lucid.object.extend(b[a],
d.onWidthChange(a,c.w));return b},hitTest:function(a,b){if(lucid.abTest.shouldShowAdvancedOptionsDrawer()){var c=lucid.plugin.getSelection();if(1===c.length&&c[0]==a&&!lucid.plugin.getProperty(a,"Lock")){var d=lucid.plugin.getProperty(a,"Rotation"),c=lucid.plugin.getProperty(a,"BoundingBox"),d=lucid.math.Point.rotate(b,lucid.math.Box.center(c),-d);lucid.plugin.getProperty(a,"FlipY")&&(d=lucid.math.Point.rotate(d,lucid.math.Box.center(c),Math.PI));var l=P(a,d);if(0<l)return{onClick:function(){E?lucid.plugin.setProperty(a,
"selectedRow",l,!0):E=!0}};if(0===l)return{onClick:function(){E=!0;lucid.plugin.setProperty(a,"selectedRow",null,!0)}}}}},preferredTextArea:function(a){if((a=lucid.plugin.getProperty(a,"selectedRow",!0))&&c.length)return c[0]+a},spatialControls:function(a){var c=[],d=lucid.plugin.getProperty(a,"BoundingBox"),h=d.y+lucid.plugin.getProperty(a,"Name_h"),l=lucid.array.filterMap(b,function(b){if(b.spatialControl){var l=c.length,m=d.x+b.x(function(b){return lucid.plugin.getProperty(a,b)});c.push(m);return{location:function(){return{x:m-
5,y:h-5,w:10,h:10}},moved:function(c){b.spatialControl(a,c.x-d.x)},path:function(){return[{x:lucid.object.get(c,l-1,d.x)+4,y:h},{x:lucid.object.get(c,l+1,d.x+d.w)-4,y:h}]}}}});if(lucid.abTest.shouldShowAdvancedOptionsDrawer()){var m=lucid.plugin.getProperty(a,"selectedRow",!0);if(m){var f=K(a),r=f[m];r&&l.push({location:function(){return r},moved:function(b,c){var d=P(a,b);0<d&&d!==m?c?(lucid.plugin.setProperty(a,"potentialSwitchRow",null,!0),R(a,m,d),lucid.plugin.setProperty(a,"selectedRow",d,!0)):
lucid.plugin.setProperty(a,"potentialSwitchRow",d,!0):lucid.plugin.setProperty(a,"potentialSwitchRow",null,!0)},path:function(){var a=lucid.math.Box.combine(f.slice(1));return[lucid.math.Box.getRelativePoint(a,.5,0),lucid.math.Box.getRelativePoint(a,.5,1)]},color:"none"})}}return l}});lucid.plugin.registerToggleControl(a,"ShadedHeader");lucid.plugin.registerToggleControl(a,"AltRows");lucid.plugin.registerStepperControl(a,"Fields",function(){return 1},function(){return 1},function(){return 1E3});lucid.plugin.registerCustomControl(a,
"FieldData");lucid.plugin.onSelectionChange(function(){E=!1;lucid.plugin.getDescendants(lucid.plugin.getActivePageId()).forEach(function(b){lucid.plugin.getBlockClassName(b)==a&&lucid.plugin.setProperty(b,"selectedRow",null,!0)})})}function w(a,b){var d=lucid.plugin.getProperty(a,"fieldNames",!0);if(0==b)return lucid.plugin.getProperty(a,"Name_h");for(var c=0,e=0;e<d.length;e++)c=Math.max(c,lucid.plugin.getProperty(a,d[e]+b+"_h")||28);return c}function B(){var a=u();return a?!!lucid.plugin.getProperty(a,
"selectedRow",!0)&&1E3>lucid.plugin.getProperty(a,"Fields"):!1}function M(){var a=u();return a?!!lucid.plugin.getProperty(a,"selectedRow",!0)&&1<lucid.plugin.getProperty(a,"Fields"):!1}function R(a,b,d){if(b!==d){var c=lucid.plugin.getProperty(a,"Fields"),e=lucid.plugin.getProperty(a,"fieldNames",!0),k=x(a);e.forEach(function(c){var k=lucid.plugin.getProperty(a,c+b);if(b<d)for(var e=b;e<d;e++)lucid.plugin.setProperty(a,c+e,lucid.plugin.getProperty(a,c+(e+1)));else if(b>d)for(e=b;e>d;e--)lucid.plugin.setProperty(a,
c+e,lucid.plugin.getProperty(a,c+(e-1)));lucid.plugin.setProperty(a,c+d,k)});c=S(c,b,d);lucid.plugin.setProperty(a,"pendingReconnect",[k,c],!0)}}function S(a,b,d){for(var c={},e=1;e<=a;e++)b<=e&&e<d?c[e+1]=e:d<e&&e<=b?c[e-1]=e:e===d?c[b]=e:c[e]=e;return c}function A(a,b){var d=lucid.plugin.getProperty(a,"selectedRow",!0);if(d){var c=b?d+1:d,d=lucid.plugin.getProperty(a,"Fields"),e=d+1,k=lucid.plugin.getProperty(a,"fieldNames",!0),g=x(a);k.forEach(function(b){for(var d=e;0<d;d--)d>c?lucid.plugin.setProperty(a,
b+d,lucid.plugin.getProperty(a,b+(d-1))):d===c&&lucid.plugin.setProperty(a,b+d,b)});for(var h={},l=1;l<=d;l++)h[l]=l<c?l:l+1;lucid.plugin.setProperty(a,"Fields",e);lucid.plugin.setProperty(a,"pendingReconnect",[g,h],!0);lucid.plugin.setPropertyIfChanged(a,"selectedRow",c,!0);lucid.text.isEditorActive()&&lucid.plugin.editBlockTextArea(a,k[0]+c)}}function L(a){var b=lucid.plugin.getProperty(a,"selectedRow",!0);if(b){var d=lucid.plugin.getProperty(a,"Fields"),c=lucid.plugin.getProperty(a,"fieldNames",
!0),e=x(a);c.forEach(function(c){for(var e=1;e<d;e++)e>=b&&lucid.plugin.setProperty(a,c+e,lucid.plugin.getProperty(a,c+(e+1)))});for(var c={},k=1;k<=d;k++)c[k]=k<b?k:k===b?"delete":k-1;lucid.plugin.setProperty(a,"Fields",d-1);lucid.plugin.setProperty(a,"pendingReconnect",[e,c],!0);lucid.plugin.setProperty(a,"selectedRow",null,!0);lucid.text.blurEditor()}}function K(a){for(var b=lucid.plugin.getProperty(a,"BoundingBox"),d=lucid.plugin.getProperty(a,"Fields"),c=[],e=b.y,k=0;k<=d;k++){var g=w(a,k);c.push({x:b.x,
y:e,w:b.w,h:g});e+=g}return c}function P(a,b){return lucid.array.findIndex(K(a),function(a){return lucid.math.Point.inBox(b,a)})}function u(){var a=lucid.plugin.getSelectionDetails();return 1===a.length&&lucid.object.contains(p,a[0].className)?a[0].id:null}function x(a){function b(b,c){var g=lucid.plugin.getProperty(b,c);if(g&&g.Block==a){for(var k=g.LinkX,g=g.LinkY,f=0,q=0;q<e.length;q++)Math.abs(e[q]-g)<Math.abs(e[f]-g)&&(f=q);(.01>k||.99<k)&&d.push({lineId:b,prop:c,field:f})}}var d=[],c=lucid.plugin.getProperty(a,
"Fields"),e=[],k=lucid.plugin.getProperty(a,"linkPoints");if(k)for(var g=0;g<=c;g++)e[g]=k[2*g+2].y;lucid.array.forEach(lucid.plugin.getConnectedLines(a),function(a){b(a,"Endpoint1");b(a,"Endpoint2")});lucid.plugin.setProperty(a,"lastLinesToFieldMap",d,!0);return d}function N(a,b,d){if(0<b.length){b=b||lucid.plugin.getProperty(a,"lastLinesToFieldMap",!0)||[];d=d||{};var c=lucid.plugin.getProperty(a,"linkPoints"),e=lucid.plugin.getProperty(a,"Fields");b.forEach(function(a){var b=a.lineId,h=a.prop;
a=a.field;var l=d[a]||a;a=lucid.plugin.getProperty(b,h);"delete"==l||l>e?(a.LinkX=.5,a.LinkY=0):(l=c[2*l+2].y,a.LinkY!=l&&(a.LinkY=l));lucid.plugin.setPropertyIfChanged(b,h,a)});lucid.plugin.setPropertyIfChanged(a,"lastLinesToFieldMap",null,!0)}}function T(a,b){for(var d=lucid.plugin.getAllProperties(a),c=d.Fields,e={},k=0;k<b.length;k++){e[b[k]]=[];for(var g=0;g<c;g++){var h=b[k]+(g+1),l=lucid.text.plainText(d[h]);e[b[k]].push({text:l,t:l,s:lucid.text.getStyle(a,h),r:g,o:d[h]})}}F=e.rowCount=c;return e}
function G(a){for(var b=v.getInput(),d={},c=a.length,e=0,k=0;k<a.length;k++)d[a[k]]=[];for(k=0;k<b.length;k++)0==k%c&&e++,d[a[k%c]].push({text:b[k].value,t:b[k].data.origText,r:b[k].data.origRow,s:b[k].data.styleData,o:b[k].data.origObject});d.rowCount=e;return H=d}function I(a,b){for(var d={tag:"ul",classes:"erd-modify-list",sortable:{revert:100,handle:".drag-handle",axis:"y",scroll:!1,update:function(){v.update(I(G(b),b))}},children:[]},c=a.rowCount,e=0;e<c;e++){for(var k=[{classes:"drag-handle ui-icon-carat-2-n-s ui-icon"}],
g=0;g<b.length;g++)k.push({tag:"input",attr:{type:"text"},value:a[b[g]][e].text,data:{styleData:a[b[g]][e].s||!1,origRow:null!=a[b[g]][e].r?a[b[g]][e].r:e,origText:a[b[g]][e].t,origObject:a[b[g]][e].o}});k.push({classes:"icon silk add",click:function(a){return function(){var c=G(b),d=c.rowCount;if(1E3>d){d++;for(var g=0;g<b.length;g++)c[b[g]].splice(a,0,{text:b[g]});c.rowCount=d;v.update(I(c,b))}}}(e+1)});k.push({classes:"icon silk delete",click:function(a){return function(){var c=G(b),d=c.rowCount;
if(1<d){for(var g=0;g<b.length;g++)c[b[g]].splice(a,1);c.rowCount=d-1;v.update(I(c,b))}}}(e)});d.children.push({tag:"li",children:k})}return{classes:"erd-modify-container size-"+b.length,children:[d]}}function U(a){var b=lucid.plugin.getProperty(a,"fieldNames",!0),d=T(a,b);v=lucid.dialog.custom(I(d,b),{title:lucid.text.plainText(lucid.plugin.getProperty(a,"Name")),closeButton:!0,modal:!0,width:100+207*b.length,buttons:[{label:lucid.i18n("button.OK"),action:function(){var c={},d=x(a),k=G(b),g=H.rowCount,
h=Math.max(g,F);lucid.plugin.getProperty(a,"Font");lucid.plugin.setPropertyIfChanged(a,"Fields",g);for(var l=0;l<b.length;l++)for(var f=0;f<g;f++){var t=k[b[l]][f];c[t.r+1]=f+1;t.text!=t.t?lucid.plugin.setPropertyIfChanged(a,b[l]+(f+1),lucid.text.styled(t.text,t.s||(f?lucid.text.getStyle(a,b[l]+f):lucid.text.getStyle(a,b[l]+"1")))):t.r!=f&&lucid.plugin.setPropertyIfChanged(a,b[l]+(f+1),t.o)}for(f=0;f<h;f++)c[f+1]||(c[f+1]="delete");lucid.plugin.setProperty(a,"pendingReconnect",[d,c],!0);v.close();
v=H=F=null}},{label:lucid.i18n("button.cancel"),action:function(){v.close();v=H=F=null}}]});v.open()}var y={global:this,provide:function(a){a=a.split(".");y.global[a[0]]=y.global[a[0]]||{};var b=y.global[a[0]];a.slice(1).reduce(function(a,b){a[b]||(a[b]={});return a[b]},b)},require:function(){},inherits:function(a,b){function d(){}d.prototype=b.prototype;a.superClass_=b.prototype;a.prototype=new d;a.prototype.constructor=a;a.base=function(a,d,k){var g=Array.prototype.slice.call(arguments,2);return b.prototype[d].apply(a,
g)}},base:function(a,b,d){var c=arguments.callee.caller;if(y.STRICT_MODE_COMPATIBLE||y.DEBUG&&!c)throw Error("arguments.caller not defined.  goog.base() cannot be used with strict mode code. See http://www.ecma-international.org/ecma-262/5.1/#sec-C");if(c.superClass_)return c.superClass_.constructor.apply(a,Array.prototype.slice.call(arguments,1));for(var e=Array.prototype.slice.call(arguments,2),k=!1,g=a.constructor;g;g=g.superClass_&&g.superClass_.constructor)if(g.prototype[b]===c)k=!0;else if(k)return g.prototype[b].apply(a,
e);if(a[b]===c)return a.constructor.prototype[b].apply(a,e);throw Error("goog.base called from a method of one name to a method of a different name");}};y.provide("plugin.erd");var p={ERD_ENTITY_BLOCK:"ERDEntityBlock",ERD_ENTITY_BLOCK_2:"ERDEntityBlock2",ERD_ENTITY_BLOCK_3:"ERDEntityBlock3",ERD_ENTITY_BLOCK_4:"ERDEntityBlock4"};if(!lucid.abTest.shouldShowAdvancedOptionsDrawer()||!lucid.newEditor)lucid.plugin.onDocumentLoaded(function(){function a(a,b){for(var c=lucid.plugin.getProperty(b[0],a),d=
1;d<b.length;d++)if(c!=lucid.plugin.getProperty(b[d],a))return null;return c}function b(b,c){function d(a,b){b||lucid.array.forEach(c.ids,function(b){lucid.plugin.setProperty(b,"Fields",a)})}e&&!c.nospace&&b.spacer();e=!0;"spinner"==c.type?(b.addGrid({width:6,content:{text:c.name+":",classes:"crop ralign"}}),b.openGrid({width:3,suffix:3}),b.addInput({type:"spinner",min:1,max:1E3,step:1,value:a(c.prop,c.ids),defaultVal:" ",onChange:d}),b.close()):"button"==c.type?(b.openGrid({width:6,prefix:3,suffix:3}),
b.addButton({onClick:function(){c.onClick(c.id)},label:c.text}),b.close()):"buttons"==c.type?c.buttons&&2==c.buttons.length&&(b.openGrid({width:12}),b.openGrid({width:6}),b.addButton({onClick:function(){c.buttons[0].onClick(c.id)},label:c.buttons[0].text}),b.close(),b.openGrid({width:6}),b.addButton({onClick:function(){c.buttons[1].onClick(c.id)},label:c.buttons[1].text}),b.close(),b.close()):"checkbox"==c.type&&(b.addGrid({width:6,content:{text:c.name+":",classes:"crop ralign"}}),b.openGrid({width:6}),
b.addInput({type:"buttonset",buttons:lucid.array.realMap([{label:"On",val:1},{label:"Off",val:0}],function(b){return{label:b.label,value:b.val,selected:function(){return!a(c.prop,c.ids)==!b.val},action:function(){!a(c.prop,c.ids)!=!b.val&&lucid.array.forEach(c.ids,function(a){lucid.plugin.setPropertyIfChanged(a,c.prop,b.val)})}}})}),b.close())}var d=lucid.template.builder(),c=d.add(),e=!1;lucid.plugin.addCustomPanel("Context Panel",null,[{content:d}],null,{isContextPanel:!0,checkShow:function(a){a=
lucid.array.filter(a,function(a){return a.isBlock});if(!lucid.array.every(a,function(a){return 0==a.className.search("ERD")}))return!1;var g=!1;e=!1;var h=lucid.template.builder(),f={ShadedHeader:{ids:[],name:"Shaded Header",type:"checkbox",prop:"ShadedHeader"},AltRows:{ids:[],name:"Alternate Row Color",type:"checkbox",prop:"AltRows"},Fields:{ids:[],name:"Fields",type:"spinner",prop:"Fields"}},m={buttons:[{onClick:U,text:"Manage Fields"},{onClick:n.exportSql,text:"Export SQL"}],type:"buttons"};classButtons=
{};lucid.object.forEach(p,function(a){classButtons[a]=m});lucid.array.forEach(a,function(a){lucid.object.forEach(f,function(b){null!=lucid.plugin.getProperty(a.id,b.prop)&&b.ids.push(a.id)})});lucid.object.forEach(f,function(a){0<a.ids.length&&(b(h,a),g=!0)});if(1==a.length&&classButtons[a[0].className]){var t=classButtons[a[0].className];t.id=a[0].id;b(h,t);g=!0}d.getElement(c).setContent(h);return g},refreshProperties:["Fields"]})});var f={Column:function(a,b,d,c,e,k){this.name=a;this.i=b;this.dataType=
d;this.maxCharLength=c;this.index=k;this.table=null;this.primary=e?[]:null;this.foreign=null}};f.Column.prototype.getId=function(){return this.table.getId().concat(this.name)};f.Column.prototype.getKeyText=function(){var a=[];this.primary&&a.push("PK");this.foreign&&a.push("FK");this.index&&a.push("AK");return a.join(",")};f.Column.prototype.getDataTypeText=function(){return this.dataType+(null!=this.maxCharLength&&0<this.maxCharLength?"("+this.maxCharLength+")":"")};f.Column.prototype.toProperties=
function(){return lucid.object.create("Key"+this.i,this.getKeyText(),"Field"+this.i,this.name,"Type"+this.i,this.getDataTypeText())};f.Column.prototype.setKeyConstraint=function(a){this.foreign=a;lucid.array.insert(a.primary||(a.primary=[]),this)};f.Table=function(a,b,d){this.name=a;this.columns=b;this.blocks=d||[];this.schema=null};f.Table.prototype.getId=function(){return this.schema.getId().concat(this.name)};f.Table.prototype.getNameText=function(){var a=this.schema.getDisplayName();return(a?
a+".":"")+this.name};f.Table.prototype.eachColumn=function(a){lucid.object.forEach(this.columns,a,this)};f.Table.prototype.toProperties=function(){var a={Name:this.getNameText(),TableId:this.getId(),Fields:lucid.object.size(this.columns)};this.eachColumn(function(b){lucid.object.extend(a,b.toProperties())});return a};f.Schema=function(a,b){this.name=a;this.tables=b;this.database=null};f.Schema.prototype.getId=function(){return this.database.getId().concat(this.name)};f.Schema.prototype.getDisplayName=
function(){switch(this.database.dbms){case "postgresql":return"public"!=this.name?this.name:"";case "sqlserver":return"dbo"!=this.name?this.name:"";default:return this.name}};f.Schema.prototype.eachTable=function(a){lucid.object.forEach(this.tables,function(b,d){a.call(this,b,d)},this)};f.Schema.prototype.eachTableSorted=function(a){lucid.object.getKeys(this.tables).sort(lucid.string.caseInsensitiveCompare).forEach(function(b){a.call(this,this.tables[b],b)},this)};f.Schema.prototype.eachColumn=function(a){this.eachTable(function(b){b.eachColumn(a)})};
f.Database=function(a,b,d){this.name=a;this.schemas=b;this.dbms=d};f.Database.prototype.getId=function(){return[this.name]};f.Database.prototype.eachSchema=function(a){lucid.object.forEach(this.schemas,function(b,d){a.call(this,b,d)},this)};f.Database.prototype.eachSchemaSorted=function(a){lucid.object.getKeys(this.schemas).sort(lucid.string.caseInsensitiveCompare).forEach(function(b){a.call(this,this.schemas[b],b)},this)};f.Database.prototype.eachTable=function(a){this.eachSchema(function(b){b.eachTable(a)})};
f.Database.prototype.eachColumn=f.Schema.prototype.eachColumn;f.Databases=function(a){this.databases=a};f.Databases.prototype.eachDatabase=function(a){lucid.object.forEach(this.databases,a,this)};f.Databases.prototype.eachSchema=function(a){this.eachDatabase(function(b){b.eachSchema(a)})};f.Databases.prototype.eachTable=f.Database.prototype.eachTable;f.Databases.prototype.eachColumn=f.Schema.prototype.eachColumn;f.Databases.prototype.getDatabase=function(a){return lucid.object.getValueByKeys(this,
"databases",a[0])};f.Databases.prototype.getSchema=function(a){return lucid.object.getValueByKeys(this,"databases",a[0],"schemas",a[1])};f.Databases.prototype.getTable=function(a){return lucid.object.getValueByKeys(this,"databases",a[0],"schemas",a[1],"tables",a[2])};f.Databases.prototype.getColumn=function(a){return lucid.object.getValueByKeys(this,"databases",a[0],"schemas",a[1],"tables",a[2],"columns",a[3])};f.Databases.prototype.serialize=function(){return{d:lucid.object.map(this.databases,function(a){return{d:a.dbms,
s:lucid.object.map(a.schemas,function(a){return{t:lucid.object.map(a.tables,function(a){return{c:lucid.object.map(a.columns,function(a){return{i:a.i,t:a.dataType,l:a.maxCharLength,p:!!a.primary,f:a.foreign&&a.foreign.getId().slice(1),x:a.index}})}})}})}})}};f.Databases.deserialize=function(a){a=a||{d:{}};var b=new f.Databases(lucid.object.map(a.d,function(a,b){return new f.Database(b,lucid.object.map(a.s,function(a,d){return new f.Schema(d,lucid.object.map(a.t,function(a,d){return new f.Table(d,lucid.object.map(a.c,
function(a,d){var e=new f.Column(d,a.i,a.t,a.l,a.p,a.x);e._foreignId=[b].concat(a.f);return e}))}))}),a.d)}));b.eachDatabase(function(a){a.eachSchema(function(c){c.database=a;c.eachTable(function(a){a.schema=c;a.eachColumn(function(c){c.table=a;if(c._foreignId){var d=b.getColumn(c._foreignId);d&&c.setKeyConstraint(d);delete c._foreignId}})})})});return b};f.getBlocks=function(){return lucid.array.filterMap(lucid.plugin.getAllBlockIds(),function(a){var b;if(lucid.string.startsWith(lucid.plugin.getBlockClassName(a),
p.ERD_ENTITY_BLOCK)&&(b=lucid.plugin.getProperty(a,"TableId")))return{id:a,tableId:b}})};f.getLines=function(){return lucid.array.filterMap(lucid.plugin.getAllLineIds(),function(a){function b(b){var e=lucid.plugin.getProperty(a,b),f;e.Block&&lucid.string.startsWith(e.Style,"CFN ERD")&&(f=lucid.plugin.getProperty(e.Block,"TableId"))&&(f=f.concat(lucid.text.plainText(lucid.plugin.getProperty(e.Block,"Field"+(lucid.array.minIndex(lucid.plugin.getProperty(e.Block,"linkPoints").map(function(a){return Math.abs(a.y-
e.LinkY)}))/2-1)))),b={id:a,key:b,blockId:e.Block,columnId:f},lucid.string.contains(e.Style,"Many")||lucid.string.contains(e.Style,"More")?d.foreign=b:d.primary=b)}var d={id:a};b("Endpoint1");b("Endpoint2");if(d.primary&&d.foreign)return d})};f.Databases.prototype.refreshBlocks=function(){this.eachTable(function(a){a.blocks=[]});var a=[];f.getBlocks().forEach(function(b){var d=this.getTable(b.tableId);d?d.blocks.push(b):a.push(b)},this);return a};f.Databases.prototype.refreshLines=function(){this.eachColumn(function(a){a.lines=
[]});var a=[];f.getLines().forEach(function(b){var d=this.getColumn(b.primary.columnId),c=this.getColumn(b.foreign.columnId);d&&c&&c.foreign==d?c.lines.push(b):a.push(b)},this);return a};f.Column.prototype.connectBlocks=function(a,b){var d=lucid.plugin.getProperty(a,"BoundingBox"),c=lucid.plugin.getProperty(b,"BoundingBox");1E5<Math.abs(d.x-c.x)||1E5<Math.abs(d.y-c.y)||(c=lucid.array.minIndex([d.x-c.x,d.x-c.x-c.w,d.x+d.w-c.x,d.x+d.w-c.x-c.w].map(Math.abs,Math)),d=lucid.plugin.getProperty(a,"linkPoints")[2*
this.i+2+(2<=c)],c=lucid.plugin.getProperty(b,"linkPoints")[2*this.foreign.i+2+c%2],lucid.plugin.addLine(lucid.plugin.getItemPageId(a),{Endpoint1:{Block:b,LinkX:c.x,LinkY:c.y,Style:"CFN ERD One Arrow"},Endpoint2:{Block:a,LinkX:d.x,LinkY:d.y,Style:"CFN ERD Many Arrow"},Shape:"elbow"}))};f.Databases.prototype.itemChanges=function(){function a(a,b,c){lucid.object.isEmpty(c)||(a[b]=c)}var b=lucid.array.filterMap(this.refreshBlocks(),function(a){if(this.getDatabase(a.tableId))return a.id},this),d={};this.eachTable(function(b){if(b.blocks.length){var c=
b.toProperties();b.blocks.forEach(function(b){a(d,b.id,lucid.object.filter(c,function(a,c){return"Fields"==c?!lucid.object.areEqual(a,lucid.plugin.getProperty(b.id,c)):"TableId"!=c?a!=lucid.text.plainText(lucid.plugin.getProperty(b.id,c)):!1}))})}},this);var c=lucid.array.filterMap(this.refreshLines(),function(a){if(this.getDatabase(a.primary.columnId)&&this.getDatabase(a.foreign.columnId))return a.id},this),e=[];this.eachColumn(function(a){a.foreign&&a.foreign.table.blocks.length&&a.table.blocks.forEach(function(b){var c=
lucid.plugin.getItemPageId(b.id);a.foreign.table.blocks.forEach(function(d){lucid.array.find(a.lines,function(a){return a.foreign.blockId==b.id&&a.primary.blockId==d.id})||c!=lucid.plugin.getItemPageId(d.id)||e.push({primary:{blockId:d.id,column:a.foreign},foreign:{blockId:b.id,column:a}})})})});var f={};this.eachColumn(function(b){b.lines.forEach(function(c){function d(a,b){var c=lucid.plugin.getProperty(a.id,a.key).LinkY;lucid.array.minIndex(lucid.plugin.getProperty(a.blockId,"linkPoints").map(function(a){return Math.abs(c-
a.y)}))/2-1!=b.i&&(e[a.key]=b.i)}var e={};d(c.foreign,b);d(c.primary,b.foreign);a(f,c.id,e)})});return{block:{deletes:b,updates:d},line:{adds:e,deletes:c,updates:f}}};f.Databases.prototype.countItemChanges=function(){var a=this.itemChanges();return{block:{deletes:a.block.deletes.length,updates:lucid.object.size(a.block.updates)},line:{adds:a.line.adds.length,deletes:a.line.deletes.length,updates:lucid.object.size(a.line.updates)}}};f.Databases.prototype.doItemChanges=function(){var a=this.itemChanges();
a.block.deletes.forEach(lucid.plugin.deleteItem);lucid.object.forEach(a.block.updates,function(a,d){lucid.object.forEach(a,function(a,b){"Fields"==b?lucid.plugin.setPropertyIfChanged(d,b,a):lucid.plugin.setText(d,b,a)})});a.line.adds.forEach(function(a){a.foreign.column.connectBlocks(a.foreign.blockId,a.primary.blockId)});a.line.deletes.forEach(lucid.plugin.deleteItem);lucid.object.forEach(a.line.updates,function(a,d){var c=lucid.plugin.getProperty(d,"linkPoints");lucid.object.forEach(a,function(a,
b){var g=lucid.plugin.getProperty(d,b);g.LinkY=c[2*a].y;lucid.plugin.setPropertyIfChanged(d,b,g)})})};var Q=[{separator:"\t",delimiter:"\x00"},{separator:","},{separator:";"}],C=function(a,b,d,c){try{return lucid.CSV.toArrays(a,Q[b],function(e){if(e&&e.length&&1<e[0].length){var k=function(){lucid.plugin.setPropertyIfChanged(null,"HiddenToolGroups",lucid.object.filter(lucid.plugin.getProperty(null,"HiddenToolGroups"),function(a,b){return!(b.startsWith("erd.js☺erd.")&&l.d[b.substring(11)])}));f.document.setData(m)};
d&&c.close();"dbms"==e[0][0].toLowerCase()&&(e=e.slice(1));var g=f.dbms[e[0][0]],h=g.fields,l=g.convert(e.map(function(a){var b={};a.forEach(function(a,c){c&&(b[h[c-1]]={NULL:!0,"null":!0,"":!0,"-":!0}[a]?null:a)});return b})),m=f.document.getData()||{d:{}};lucid.object.extend(m.d,l.d);e=f.Databases.deserialize(m).countItemChanges();g=[];e.block.updates&&g.push("update "+e.block.updates+(1<e.block.updates?" shapes":" shape"));e.block.deletes&&g.push("delete "+e.block.deletes+(1<e.block.deletes?" shapes":
" shape"));e.line.adds&&g.push("add "+e.line.adds+(1<e.line.adds?" lines":" line"));e.line.updates&&g.push("update "+e.line.updates+(1<e.line.updates?" lines":" line"));e.line.deletes&&g.push("delete "+e.line.deletes+(1<e.line.deletes?" lines":" line"));if(g.length){1==g.length?e=g[0]:2==g.length?e=g.join(" and "):(g[g.length-1]="and "+g[g.length-1],e=g.join(", "));var n=lucid.dialog.custom({children:["In addition to updating the toolbox, would also you like to update the existing ERD shapes on your document?",
{tag:"br"},"(This would "+e+".)"]},{title:"Update ERD shapes",modal:!0,closeButton:!0,buttons:[{label:"Yes",action:function(){n.destroy();k();f.databases.doItemChanges()}},{label:"No, toolbox only",action:function(){k();n.destroy()}}]});n.open()}else k();return!0}if(b+1<Q.length)return C(a,b+1,d,c);lucid.dialog.alert("Could not parse the results. Make sure the results are correctly formatted.");return!1})}catch(e){return lucid.dialog.alert("Could not parse the results. Make sure the results are correctly formatted."),
!1}};f.toolbox={};f.toolbox.groups=[];f.toolbox.erdGroups=[p.ERD_ENTITY_BLOCK,p.ERD_ENTITY_BLOCK_2,p.ERD_ENTITY_BLOCK_3,p.ERD_ENTITY_BLOCK_4,{label:"Import",action:function(){lucid.log.analytics("erd.auto.import");lucid.CSV.init();var a=lucid.template.builder();a.add({tag:"p",html:lucid.i18n("erd.beta.label")});a.add({tag:"label",text:"1.Choose your DBMS"});a.addInput({type:"radio",separator:'<span style="margin-left:6px"/>',buttons:[{label:"MySQL",value:"mysql"},{label:"Oracle",value:"oracle"},{label:"PostgreSQL",
value:"postgresql"},{label:"SQL Server",value:"sqlserver"}],onChange:function(c){c=f.dbms[c].query.trim().replace(/\s+/g," ").replace(/\s([,;)(=])/g,"$1").replace(/([,;)(=])\s/g,"$1");a.getElement(b).text(c)}});a.spacer();a.add({tag:"label",text:"2. Run the following query on your database:"});a.add({css:{height:"3px"}});var b=a.add({id:"queryTextArea",tag:"textarea",attr:{rows:"8",readonly:"readonly"},css:{display:"block","font-size":"10px",width:"376px",height:"150px",resize:"none"}});a.spacer();
a.add({tag:"label",text:"3. Import the tab-, semicolon-, or comma-separated results"});a.addInput({type:"file",onSuccess:function(a){lucid.log.analytics("erd.auto.import.file");C(a,0,!0,d)}});a.spacer();a.add({tag:"label",text:"Or paste the results below:"});a.add({css:{height:"3px"}});var d=lucid.dialog.textAreaPrompt(a.getTemplate(),null,function(a){lucid.log.analytics("erd.auto.import.paste");C(a,0,void 0,d)},null,{height:"200px"})}},{label:"Export",action:function(){n.exportSql()}}];f.toolbox.add=
function(){var a={"Entity Relationship":f.toolbox.erdGroups};if(f.databases){var b=lucid.plugin.getToolGroupOrder("Entity Relationship"),d=[];f.databases.eachDatabase(function(b,e){b.eachSchemaSorted(function(b,c){var h="erd."+e,l=b.getDisplayName();a[h]||(a[h]=[]);l&&a[h].push({template:{text:l,css:{"font-weight":"bold","font-style":"italic"}}});b.eachTableSorted(function(b,c){function d(a){return lucid.text.measure(lucid.array.maxElement(l.map(a),function(a){return a.length})).w}function e(){return d(function(a){return a.getKeyText()||
"PK"})+20}function g(){return d(function(a){return a.name})+20}function f(){return d(function(a){return a.getDataTypeText()})+20}var k=b.getNameText(),l=lucid.object.getValues(b.columns);a[h].push({category:h,className:p.ERD_ENTITY_BLOCK_4,name:k,tooltip:c,helperText:c,noBlockPrompt:!0,defaultProperties:function(){var a=b.toProperties();a.Column1=e();a.Column2=f();return a},defaultSize:function(){return{w:Math.max(160,e()+g()+f(),lucid.text.measure(k).w+20),h:42.5+28*lucid.object.size(b.columns)}}})});
l="erd."+e;f.toolbox.groups.push(l);lucid.plugin.setToolGroupOptions(l,{displayName:e,menuItems:[{label:"Remove from toolbox",action:function(){delete f.databases.databases[e];f.document.setData(f.databases.serialize())}}]});-1==lucid.plugin.getToolGroupOrder(l)&&d.push(l)})});lucid.plugin.createToolGroups(a);0<d.length&&lucid.plugin.setToolGroupsOrder(d,b)}else lucid.plugin.createToolGroups(a)};f.document={};f.document.KEY="ERDData";f.document.getData=function(){return lucid.plugin.getProperty(null,
f.document.KEY)};f.document.setData=function(a){lucid.plugin.setPropertyIfChanged(null,f.document.KEY,a)};f.databases=null;var J=!1;lucid.plugin.onDocumentLoaded(function(){J=!0;var a=f.document.getData();lucid.plugin.registerProperty(null,f.document.KEY,a,null,function(a,d){f.databases=f.Databases.deserialize(d);f.toolbox.add()})});f.dbms={};f.dbms.mysql={fields:"tableSchema tableName columnName ordinalPosition dataType characterMaximumLength constraintType referencedTableSchema referencedTableName referencedColumnName".split(" "),
query:"SELECT 'mysql' dbms, t.TABLE_SCHEMA, t.TABLE_NAME, c.COLUMN_NAME, c.ORDINAL_POSITION, c.DATA_TYPE, c.CHARACTER_MAXIMUM_LENGTH, n.CONSTRAINT_TYPE, k.REFERENCED_TABLE_SCHEMA, k.REFERENCED_TABLE_NAME, k.REFERENCED_COLUMN_NAME FROM INFORMATION_SCHEMA.TABLES t LEFT JOIN INFORMATION_SCHEMA.COLUMNS c ON t.TABLE_SCHEMA = c.TABLE_SCHEMA AND t.TABLE_NAME = c.TABLE_NAME LEFT JOIN INFORMATION_SCHEMA.KEY_COLUMN_USAGE k ON c.TABLE_SCHEMA = k.TABLE_SCHEMA AND c.TABLE_NAME = k.TABLE_NAME AND c.COLUMN_NAME = k.COLUMN_NAME LEFT JOIN INFORMATION_SCHEMA.TABLE_CONSTRAINTS n ON k.CONSTRAINT_SCHEMA = n.CONSTRAINT_SCHEMA AND k.CONSTRAINT_NAME = n.CONSTRAINT_NAME AND k.TABLE_SCHEMA = n.TABLE_SCHEMA AND k.TABLE_NAME = n.TABLE_NAME WHERE t.TABLE_TYPE = 'BASE TABLE' AND t.TABLE_SCHEMA NOT IN ('INFORMATION_SCHEMA', 'mysql');",
convert:function(a){var b={d:{}};a.forEach(function(a){var c=lucid.object.setIfUndefined(lucid.object.setIfUndefined(lucid.object.setIfUndefined(b.d,a.tableSchema,{d:"mysql",s:{}}).s,"",{t:{}}).t,a.tableName,{c:{}});a.columnName&&(c=lucid.object.setIfUndefined(c.c,a.columnName,{}),c.i=parseInt(a.ordinalPosition,10),c.t=a.dataType,c.l=a.characterMaximumLength?parseInt(a.characterMaximumLength,10):null,c.p=c.p||"PRIMARY KEY"==a.constraintType,c.f=c.f||a.referencedColumnName&&["",a.referencedTableName,
a.referencedColumnName],c.x=c.x||"UNIQUE"==a.constraintType)});return b}};f.dbms.oracle={fields:"databaseName owner tableName columnName columnId dataType dataLength constraintType referencedOwner referencedTable referencedColumn".split(" "),query:"SELECT 'oracle' dbms, ORA_DATABASE_NAME, t.OWNER, t.TABLE_NAME, c.COLUMN_NAME, c.COLUMN_ID, c.DATA_TYPE, c.DATA_LENGTH, n.CONSTRAINT_TYPE, r.OWNER , r.TABLE_NAME , r.COLUMN_NAME FROM ALL_TABLES t LEFT JOIN ALL_TAB_COLS c ON t.OWNER = c.OWNER AND t.TABLE_NAME = c.TABLE_NAME LEFT JOIN ALL_CONS_COLUMNS nc ON c.OWNER = nc.OWNER AND c.TABLE_NAME = nc.TABLE_NAME AND c.COLUMN_NAME = nc.COLUMN_NAME LEFT JOIN ALL_CONSTRAINTS n ON nc.OWNER = n.OWNER AND nc.CONSTRAINT_NAME = n.CONSTRAINT_NAME AND n.CONSTRAINT_TYPE IN ('P', 'U', 'R') LEFT JOIN ALL_CONS_COLUMNS r ON n.R_OWNER = r.OWNER AND n.R_CONSTRAINT_NAME = r.CONSTRAINT_NAME AND nc.POSITION = r.POSITION WHERE c.COLUMN_NAME IS NOT NULL;",
convert:function(a){var b={d:{}};a.forEach(function(a){var c=lucid.object.setIfUndefined(lucid.object.setIfUndefined(lucid.object.setIfUndefined(b.d,a.databaseName||"Oracle",{d:"oracle",s:{}}).s,a.owner||"",{t:{}}).t,a.tableName,{c:{}}),c=lucid.object.setIfUndefined(c.c,a.columnName,{});c.i=parseInt(a.columnId,10);c.t=a.dataType.toLowerCase();c.l=a.dataLength&&"number"!=c.t?parseInt(a.dataLength,10):null;c.p=c.p||"P"==a.constraintType;c.f=c.f||a.referencedOwner&&[a.referencedOwner,a.referencedTable,
a.referencedColumn];c.x=c.x||"U"==a.constraintType});return b}};f.dbms.postgresql={fields:"tableCatalog tableSchema tableName columnName ordinalPosition dataType characterMaximumLength constraintType referencedSchema referencedTable referencedColumn".split(" "),query:"SELECT 'postgresql' AS dbms, t.table_catalog, t.table_schema, t.table_name, c.column_name, c.ordinal_position, c.data_type, c.character_maximum_length, n.constraint_type, k2.table_schema, k2.table_name, k2.column_name FROM information_schema.tables t NATURAL LEFT JOIN information_schema.columns c LEFT JOIN (information_schema.key_column_usage k NATURAL JOIN information_schema.table_constraints n NATURAL LEFT JOIN information_schema.referential_constraints r)ON c.table_catalog = k.table_catalog AND c.table_schema = k.table_schema AND c.table_name = k.table_name AND c.column_name = k.column_name LEFT JOIN information_schema.key_column_usage k2 ON k.position_in_unique_constraint = k2.ordinal_position AND r.unique_constraint_catalog = k2.constraint_catalog AND r.unique_constraint_schema = k2.constraint_schema AND r.unique_constraint_name = k2.constraint_name WHERE t.TABLE_TYPE = 'BASE TABLE' AND t.table_schema NOT IN ('information_schema', 'pg_catalog');",
convert:function(a){var b={d:{}};a.forEach(function(a){var c=lucid.object.setIfUndefined(lucid.object.setIfUndefined(lucid.object.setIfUndefined(b.d,a.tableCatalog,{d:"postgresql",s:{}}).s,a.tableSchema,{t:{}}).t,a.tableName,{c:{}});a.columnName&&(c=lucid.object.setIfUndefined(c.c,a.columnName,{}),c.i=parseInt(a.ordinalPosition,10),c.t=a.dataType,c.l=a.characterMaximumLength?parseInt(a.characterMaximumLength,10):null,c.p=c.p||"PRIMARY KEY"==a.constraintType,c.f=c.f||a.referencedColumn&&[a.referencedSchema,
a.referencedTable,a.referencedColumn],c.x=c.x||"UNIQUE"==a.constraintType)});return b}};f.dbms.sqlserver={fields:"tableCatalog tableSchema tableName columnName ordinalPosition dataType characterMaximumLength constraintType referencedSchema referencedTable referencedColumn".split(" "),query:"SELECT 'sqlserver' dbms, t.TABLE_CATALOG, t.TABLE_SCHEMA, t.TABLE_NAME, c.COLUMN_NAME, c.ORDINAL_POSITION, c.DATA_TYPE, c.CHARACTER_MAXIMUM_LENGTH, n.CONSTRAINT_TYPE, k2.TABLE_SCHEMA, k2.TABLE_NAME, k2.COLUMN_NAME FROM INFORMATION_SCHEMA.TABLES t LEFT JOIN INFORMATION_SCHEMA.COLUMNS c ON t.TABLE_CATALOG = c.TABLE_CATALOG AND t.TABLE_SCHEMA = c.TABLE_SCHEMA AND t.TABLE_NAME = c.TABLE_NAME LEFT JOIN (INFORMATION_SCHEMA.KEY_COLUMN_USAGE k JOIN INFORMATION_SCHEMA.TABLE_CONSTRAINTS n ON k.CONSTRAINT_CATALOG = n.CONSTRAINT_CATALOG AND k.CONSTRAINT_SCHEMA = n.CONSTRAINT_SCHEMA AND k.CONSTRAINT_NAME = n.CONSTRAINT_NAME LEFT JOIN INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS r ON k.CONSTRAINT_CATALOG = r.CONSTRAINT_CATALOG AND k.CONSTRAINT_SCHEMA = r.CONSTRAINT_SCHEMA AND k.CONSTRAINT_NAME = r.CONSTRAINT_NAME)ON c.TABLE_CATALOG = k.TABLE_CATALOG AND c.TABLE_SCHEMA = k.TABLE_SCHEMA AND c.TABLE_NAME = k.TABLE_NAME AND c.COLUMN_NAME = k.COLUMN_NAME LEFT JOIN INFORMATION_SCHEMA.KEY_COLUMN_USAGE k2 ON k.ORDINAL_POSITION = k2.ORDINAL_POSITION AND r.UNIQUE_CONSTRAINT_CATALOG = k2.CONSTRAINT_CATALOG AND r.UNIQUE_CONSTRAINT_SCHEMA = k2.CONSTRAINT_SCHEMA AND r.UNIQUE_CONSTRAINT_NAME = k2.CONSTRAINT_NAME WHERE t.TABLE_TYPE = 'BASE TABLE';",
convert:function(a){var b={d:{}};a.forEach(function(a){var c=lucid.object.setIfUndefined(lucid.object.setIfUndefined(lucid.object.setIfUndefined(b.d,a.tableCatalog,{d:"sqlserver",s:{}}).s,a.tableSchema,{t:{}}).t,a.tableName,{c:{}});a.columnName&&(c=lucid.object.setIfUndefined(c.c,a.columnName,{}),c.i=parseInt(a.ordinalPosition,10),c.t=a.dataType,c.l=a.characterMaximumLength?parseInt(a.characterMaximumLength,10):null,c.p=c.p||"PRIMARY KEY"==a.constraintType,c.f=c.f||a.referencedColumn&&[a.referencedSchema,
a.referencedTable,a.referencedColumn],c.x=c.x||"UNIQUE"==a.constraintType)});return b}};var O={};lucid.plugin.onDocumentLoaded(function(){void 0===lucid.plugin.getProperty(null,"erd-v2")&&lucid.text.awaitMetrics().then(function(){lucid.plugin.withSilentActions(function(){lucid.plugin.getAllBlockIds().filter(function(a){return lucid.string.startsWith(lucid.plugin.getBlockClassName(a),p.ERD_ENTITY_BLOCK)}).forEach(function(a){function b(b,c){var d=lucid.text.getSize(a,b),e=d&&d.h+10||c,e=Math.round(Math.max(c,
e));lucid.plugin.setProperty(a,b+"_h",e);d&&(d.h/=1.2);return Math.round(Math.max(c,d&&d.h+10||c))}function d(b,d){var g=lucid.plugin.getProperty(b,d);if(g&&g.Block==a){for(var f=g.LinkX,g=g.LinkY,h=0,k=0;k<e.length;k++)Math.abs(e[k]/c-g)<Math.abs(e[h]/c-g)&&(h=k);(.01>f||.99<f)&&m.push({lineId:b,prop:d,field:h})}}var c=0,e=[],f=b("Name",40);e.push(c+f/2);for(var c=c+f,f=lucid.plugin.getProperty(a,"fieldNames",!0),g=lucid.plugin.getProperty(a,"Fields"),h=1;h<=g;h++){var l=0;f.forEach(function(a){l=
Math.max(l,b(a+h,20))});e.push(c+l/2);c+=l}var m=[];lucid.array.forEach(lucid.plugin.getConnectedLines(a),function(a){d(a,"Endpoint1");d(a,"Endpoint2")});O[a](m)});lucid.plugin.setProperty(null,"erd-v2",!0)})})});var D=!1;lucid.plugin.beforeCurrentUserNewAction(function(){D=!0});lucid.plugin.afterCurrentUserNewAction(function(){D=!1});var E=!1;lucid.abTest.shouldShowAdvancedOptionsDrawer()&&lucid.plugin.addContextMenuItems([{external:!0,label:"Insert Row Above",logAction:"plugin.erd.contextMenu.addRow.above",
action:function(){var a=u();a&&A(a)},visible:B},{external:!0,label:"Insert Row Below",logAction:"plugin.erd.contextMenu.addRow.below",action:function(){var a=u();a&&A(a,!0)},visible:B},{external:!0,label:"Delete Row",logAction:"plugin.erd.contextMenu.deleteRow",action:function(){var a=u();a&&L(a)},visible:M}]);z(p.ERD_ENTITY_BLOCK,[{name:"Field",align:"left"}]);z(p.ERD_ENTITY_BLOCK_2,[{name:"Key",align:"center"},{name:"Field",align:"left",x:function(a){a=a("Column1");return null!=a?a:60},spatialControl:function(a,
b){lucid.plugin.setPropertyIfChanged(a,"Column1",b)}}],{defaultProperties:{Column1:60},sampleProperties:{Column1:6},onWidthChange:function(a,b){var d={},c=lucid.plugin.getProperty(a,"Column1");null!=c&&c>b-8&&(d.Column1=Math.max(b/2,b-8));return d}});z(p.ERD_ENTITY_BLOCK_3,[{name:"Field",align:"left"},{name:"Type",align:"left",x:function(a){var b=a("Column1");return null!=b?b:a("BoundingBox").w/2},spatialControl:function(a,b){lucid.plugin.setPropertyIfChanged(a,"Column1",b)}}],{defaultProperties:{Column1:100},
onWidthChange:function(a,b){var d={},c=lucid.plugin.getProperty(a,"Column1");null!=c&&c>b-8&&(d.Column1=Math.max(b/2,b-8));return d}});z(p.ERD_ENTITY_BLOCK_4,[{name:"Key",align:"center"},{name:"Field",align:"left",x:function(a){a=a("Column1");return null!=a?a:60},spatialControl:function(a,b){lucid.plugin.setPropertyIfChanged(a,"Column1",b)}},{name:"Type",align:"left",x:function(a){var b=a("Column2");a=a("BoundingBox").w;return null!=b?a-b:(a-60)/2+60},spatialControl:function(a,b){lucid.plugin.setPropertyIfChanged(a,
"Column2",lucid.plugin.getProperty(a,"BoundingBox").w-b)}}],{defaultProperties:{Column1:60,Column2:60},sampleProperties:{Column1:5,Column2:10},onWidthChange:function(a,b){var d={},c=lucid.plugin.getProperty(a,"Column1"),e=lucid.plugin.getProperty(a,"Column2");null!=c&&c>b-16&&(d.Column1=c=Math.max(b/3,b-16));null!=e&&e>b-c-8&&(d.Column2=Math.max((b-c)/2,b-c-8));return d}});lucid.line.addEndpointStyles("erd",{"CFN ERD Zero Or More Arrow":function(a,b,d,c,e,f){b=Math.atan2(b.y,b.x);return[{StrokeColor:d,
LineWidth:c,NoRounding:!0,Actions:[{Action:"move",x:a.x+10*Math.cos(b+Math.PI/2),y:a.y+10*Math.sin(b+Math.PI/2)},{Action:"line",x:a.x-20*Math.cos(b),y:a.y-20*Math.sin(b)},{Action:"line",x:a.x+10*Math.cos(b-Math.PI/2),y:a.y+10*Math.sin(b-Math.PI/2)}]},{StrokeColor:d,FillColor:"#FFFFFF",LineWidth:c,NoRounding:!0,Actions:[{Action:"move",x:a.x+10-30*Math.cos(b),y:a.y-30*Math.sin(b)},{Action:"curve",Control:lucid.math.ellipseArcControlPoints(a.x+10-30*Math.cos(b)-20,a.y-30*Math.sin(b)-10,20,20)}]}]},"CFN ERD One Or More Arrow":function(a,
b,d,c,e,f){b=Math.atan2(b.y,b.x);return[{StrokeColor:d,LineWidth:c,NoRounding:!0,Actions:[{Action:"move",x:a.x+10*Math.cos(b+Math.PI/2),y:a.y+10*Math.sin(b+Math.PI/2)},{Action:"line",x:a.x-20*Math.cos(b),y:a.y-20*Math.sin(b)},{Action:"line",x:a.x+10*Math.cos(b-Math.PI/2),y:a.y+10*Math.sin(b-Math.PI/2)}]},{StrokeColor:d,FillColor:"#FFFFFF",LineWidth:c,NoRounding:!0,Actions:[{Action:"move",x:a.x-Math.sqrt(500)*Math.cos(b+Math.atan(.5)),y:a.y-Math.sqrt(500)*Math.sin(b+Math.atan(.5))},{Action:"line",
x:a.x-Math.sqrt(500)*Math.cos(b-Math.atan(.5)),y:a.y-Math.sqrt(500)*Math.sin(b-Math.atan(.5))}]}]},"CFN ERD Many Arrow":function(a,b,d,c,e,f){b=Math.atan2(b.y,b.x);return[{StrokeColor:d,LineWidth:c,NoRounding:!0,Actions:[{Action:"move",x:a.x+10*Math.cos(b+Math.PI/2),y:a.y+10*Math.sin(b+Math.PI/2)},{Action:"line",x:a.x-20*Math.cos(b),y:a.y-20*Math.sin(b)},{Action:"line",x:a.x+10*Math.cos(b-Math.PI/2),y:a.y+10*Math.sin(b-Math.PI/2)}]}]},"CFN ERD Exactly One Arrow":function(a,b,d,c,e,f){b=Math.atan2(b.y,
b.x);return[{StrokeColor:d,FillColor:"#FFFFFF",LineWidth:c,NoRounding:!0,Actions:[{Action:"move",x:a.x-Math.sqrt(200)*Math.cos(b+Math.PI/4),y:a.y-Math.sqrt(200)*Math.sin(b+Math.PI/4)},{Action:"line",x:a.x-Math.sqrt(200)*Math.cos(b-Math.PI/4),y:a.y-Math.sqrt(200)*Math.sin(b-Math.PI/4)}]},{StrokeColor:d,FillColor:"#FFFFFF",LineWidth:c,NoRounding:!0,Actions:[{Action:"move",x:a.x-Math.sqrt(500)*Math.cos(b+Math.atan(.5)),y:a.y-Math.sqrt(500)*Math.sin(b+Math.atan(.5))},{Action:"line",x:a.x-Math.sqrt(500)*
Math.cos(b-Math.atan(.5)),y:a.y-Math.sqrt(500)*Math.sin(b-Math.atan(.5))}]}]},"CFN ERD Zero Or One Arrow":function(a,b,d,c,e,f){b=Math.atan2(b.y,b.x);return[{StrokeColor:d,FillColor:"#FFFFFF",LineWidth:c,NoRounding:!0,Actions:[{Action:"move",x:a.x-Math.sqrt(200)*Math.cos(b+Math.PI/4),y:a.y-Math.sqrt(200)*Math.sin(b+Math.PI/4)},{Action:"line",x:a.x-Math.sqrt(200)*Math.cos(b-Math.PI/4),y:a.y-Math.sqrt(200)*Math.sin(b-Math.PI/4)}]},{StrokeColor:d,FillColor:"#FFFFFF",LineWidth:c,NoRounding:!0,Actions:[{Action:"move",
x:a.x+10-30*Math.cos(b),y:a.y-30*Math.sin(b)},{Action:"curve",Control:lucid.math.ellipseArcControlPoints(a.x+10-30*Math.cos(b)-20,a.y-30*Math.sin(b)-10,20,20)}]}]},"CFN ERD One Arrow":function(a,b,d,c,e,f){b=Math.atan2(b.y,b.x);return[{StrokeColor:d,FillColor:"#FFFFFF",LineWidth:c,NoRounding:!0,Actions:[{Action:"move",x:a.x-Math.sqrt(500)*Math.cos(b+Math.atan(.5)),y:a.y-Math.sqrt(500)*Math.sin(b+Math.atan(.5))},{Action:"line",x:a.x-Math.sqrt(500)*Math.cos(b-Math.atan(.5)),y:a.y-Math.sqrt(500)*Math.sin(b-
Math.atan(.5))}]}]}});var v=null,F=null,H=null,n={exportSql:function(a){a=n.loadState(a);a=n.convertToTables(a);a=n.Converter.convertAll(a);lucid.sql.exportSql(a)},loadState:function(a){var b=[],d=[];if(a)b.push(a);else var c=lucid.plugin.getActivePageId(),b=lucid.plugin.getAllBlockIds().filter(function(a){return lucid.string.startsWith(lucid.plugin.getBlockClassName(a),p.ERD_ENTITY_BLOCK)&&lucid.plugin.getItemPageId(a)==c});for(a=0;a<b.length;a++){var e=n.getBlockName(b[a]),f=n.getBlockColumns(b[a]);
d.push({name:e,columns:f})}return d},getBlockName:function(a){a=lucid.plugin.getProperty(a,"Name");return lucid.text.plainText(a)},getBlockColumns:function(a){var b=lucid.plugin.getAllProperties(a),d=b.Fields;a=lucid.plugin.getProperty(a,"fieldNames",!0);for(var c=[],e=0;e<d;e++){var f={};a.forEach(function(a){var c=lucid.text.plainText(b[a+(e+1)]);f[n.mapFieldName(a)]=c});c.push(f)}return c},mapFieldName:function(a){return"Field"==a?"name":"Type"==a?"type":"Key"==a?"key":a},convertToTables:function(a){return a.map(function(a){return new n.Schema.Table(a.name,
a.columns.map(function(a){return new n.Schema.Column(a.name,a.type,a.restrictNull,a.key)}))})},Schema:{Table:function(a,b){this.name=a;this.columns=b},Column:function(a,b,d,c){this.name=a;this.type=b;this.restrictNull=!!d;this.key=c}},Converter:{}};n.Converter.dbmsList=["mysql","postgresql","sqlserver","oracle"];n.Converter.convertAll=function(a){var b={};n.Converter.dbmsList.map(function(d){b[d]=n.Converter.convert(a,d)});return b};n.Converter.convert=function(a,b){return"oracle"==b?n.Converter.toOracle(a):
"postgresql"==b?n.Converter.toPostgreSql(a):"sqlserver"==b?n.Converter.toSqlServer(a):n.Converter.toMySql(a)};n.Converter.toMySql=function(a){var b="";a.forEach(function(a){var c="CREATE TABLE `",c=c+a.name,c=c+"` (\n";a.columns.forEach(function(a,b){c+="  `";c+=a.name;c+="`";a.type?(c+=" ",c+=a.type):c+=" <type>";a.restrictNull&&(c+=" NOT NULL");c+=",\n"});a=n.Converter.getKeyColumns(a.columns);a.PK&&(c+="  PRIMARY KEY (`"+a.PK.join("`, `")+"`),\n",delete a.PK);for(var e in a)c+="  KEY `"+e+"` (`"+
a[e].join("`, `")+"`),\n";c=lucid.string.removeAt(c,c.length-2,1);c+=");\n\n";b+=c});return b};n.Converter.toPostgreSql=function(a){var b="";a.forEach(function(a){var c='CREATE TABLE "',c=c+a.name,c=c+'" (\n';a.columns.forEach(function(a,b){c+='  "';c+=a.name;c+='"';a.type?(c+=" ",c+=a.type):c+=" <type>";a.restrictNull&&(c+=" NOT NULL");c+=",\n"});var e=n.Converter.getKeyColumns(a.columns);e.PK&&(c+='  PRIMARY KEY ("'+e.PK.join('", "')+'"),\n',delete e.PK);var c=lucid.string.removeAt(c,c.length-2,
1),c=c+");\n\n",f;for(f in e)c+='CREATE INDEX "'+f+'" ON  "'+a.name+'" ("'+e[f].join('", "')+'");\n\n';b+=c});return b};n.Converter.toSqlServer=function(a){var b="";a.forEach(function(a){var c="CREATE TABLE [",c=c+a.name,c=c+"] (\n";a.columns.forEach(function(a,b){c+="  [";c+=a.name;c+="]";a.type?(c+=" ",c+=a.type):c+=" <type>";a.restrictNull&&(c+=" NOT NULL");c+=",\n"});var e=n.Converter.getKeyColumns(a.columns);e.PK&&(c+="  PRIMARY KEY (["+e.PK.join("], [")+"]),\n",delete e.PK);var c=lucid.string.removeAt(c,
c.length-2,1),c=c+");\n\n",f;for(f in e)c+="CREATE INDEX ["+f+"] ON  ["+a.name+"] (["+e[f].join("], [")+"]);\n\n";b+=c});return b};n.Converter.toOracle=function(a){var b="";a.forEach(function(a){var c='CREATE TABLE "',c=c+a.name,c=c+'" (\n';a.columns.forEach(function(a,b){c+='  "';c+=a.name;c+='"';a.type?(c+=" ",c+=a.type):c+=" <type>";a.restrictNull&&(c+=" NOT NULL");c+=",\n"});var e=n.Converter.getKeyColumns(a.columns);e.PK&&(c+='  PRIMARY KEY ("'+e.PK.join('", "')+'"),\n',delete e.PK);var c=lucid.string.removeAt(c,
c.length-2,1),c=c+");\n\n",f;for(f in e)c+='CREATE INDEX "'+f+'" ON  "'+a.name+'" ("'+e[f].join('", "')+'");\n\n';b+=c});return b};n.Converter.getKeyColumns=function(a){var b={};a.forEach(function(a){a.key&&(b[a.key]||(b[a.key]=[]),b[a.key].push(a.name))});return b};lucid.plugin.onActivate(function(){f.toolbox.add();lucid.line.enableEndpointStyles("erd")});lucid.plugin.onDeactivate(function(){lucid.line.disableEndpointStyles("erd")});lucid.plugin.createToolGroups({"Entity Relationship":f.toolbox.erdGroups});
lucid.plugin.createNextBlockGroup([p.ERD_ENTITY_BLOCK,p.ERD_ENTITY_BLOCK_2,p.ERD_ENTITY_BLOCK_3,p.ERD_ENTITY_BLOCK_4])})();
//# sourceMappingURL=/js/plugins/v2/source-maps/erd.js.map
};
